# ==================== 业务实体定义 ====================

# 用户实体
type User @entity(immutable: false) {
  id: ID!                     # address
  address: Bytes!            # 用户地址
  totalFiles: BigInt!         # 文件总数
  freeLoad: BigInt!          # 可用空间（默认存储）
  maxLoad: BigInt!           # 最大空间（默认存储）
  isLocked: Boolean!         # 是否被锁定
  totalNodes: BigInt!        # 拥有的节点总数
  files: [File!]! @derivedFrom(field: "owner")  # 用户拥有的文件
  storageNodes: [StorageNode!]! @derivedFrom(field: "owner")  # 用户拥有的存储节点
  createdAt: BigInt!         # 注册时间
  updatedAt: BigInt!         # 最后更新时间
}

# 文件实体
type File @entity(immutable: false) {
  id: ID!                    # unique id (owner address + cid)
  cid: String!              # IPFS CID
  owner: User!              # 文件所有者
  size: BigInt!             # 文件大小
  fileType: String!         # 文件类型
  fileName: String!         # 文件名
  storageNodeId: BigInt!    # 存储节点ID（0=默认，>0=购买的节点）
  storageNode: StorageNode  # 关联的存储节点（如果有）
  isActive: Boolean!        # 是否激活
  status: FileStatus!       # 文件状态
  createdAt: BigInt!        # 创建时间
  updatedAt: BigInt!        # 最后更新时间
  removedAt: BigInt          # 删除时间
}

# 存储节点实体
type StorageNode @entity(immutable: false) {
  id: ID!                    # unique id (owner address + nodeId)
  nodeId: BigInt!           # 节点ID（0为默认节点，>0为购买的节点）
  owner: User!              # 节点所有者
  providerAddress: Bytes!   # 存储提供商地址
  totalSpace: BigInt!       # 节点总空间
  usedSpace: BigInt!        # 已使用空间
  availableSpace: BigInt!   # 可用空间
  isActive: Boolean!        # 节点是否激活
  purchaseTime: BigInt!     # 购买时间
  files: [File!]! @derivedFrom(field: "storageNode")  # 存储在此节点的文件
  createdAt: BigInt!        # 创建时间
  updatedAt: BigInt!        # 最后更新时间
  deactivatedAt: BigInt     # 停用时间
}

# 文件状态枚举
enum FileStatus {
  ACTIVE
  INACTIVE
  REMOVED
}

# 系统统计信息
type SystemStats @entity(immutable: false) {
  id: ID!                    # 唯一标识符 (固定为 "system")
  totalUsers: BigInt!       # 总用户数
  totalFiles: BigInt!       # 总文件数
  activeFiles: BigInt!      # 活跃文件数
  totalStorage: BigInt!     # 总存储使用量（字节）
  totalNodes: BigInt!       # 总节点数
  activeNodes: BigInt!      # 活跃节点数
  updatedAt: BigInt!        # 最后更新时间
}
